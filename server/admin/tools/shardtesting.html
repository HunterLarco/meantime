<!DOCTYPE>
<html>
<head>
<style type='text/css'>

body{
  padding:0px;
  margin:0px;
  font-family:arial;
  font-size:15px;
}


input{
  padding: 6px 7px !important;
}



div.shard{
  padding-bottom:20px;
  border-bottom:4px solid rgb(200,200,200);
  background:rgb(240,240,240);
  margin:20px;
  display:inline-block;
  overflow:hidden;
  color:rgb(51,51,51);
  vertical-align:top;
}


div.shard div.input{
  margin:2px 20px;
  position:relative;
  display:inline-block;
}
div.shard div.input span{
  position:absolute;
  right:0px;
  top:0px;
  font-size:14px;
  padding:8px 7px;
  color:rgb(200,200,200);
}
div.shard div.divider{
  margin:20px 0px;
  height:8px;
  background:white;
}
div.shard div.button{
  margin:4px 20px;
  display:block;
}
div.shard div.stats{
  margin:0px 20px;
  background:rgb(255,255,255);
  border-bottom:1px solid rgb(220,220,220);
  padding:12px;
  line-height:28px;
  color:rgb(180,180,180);
}
div.shard div.stats label{
  color:rgb(51,51,51);
}


div.shard div.title{
  padding:16px 0px;
  text-align:center;
  font-size:18px;
  background:rgb(203,78,78);
  color:rgb(255,255,255);
  border-bottom:1px solid rgb(153,28,28);
  margin-bottom:20px;
  box-shadow:0px 1px 2px rgba(0,0,0,0.4);
}


div.shard div.options{
  padding:12px 20px;
  line-height:22px;
}


input[type='radio']{
	padding:0px !important;
	margin:0px;
	background:rgb(248,248,248);
	appearance:none;
	-webkit-appearance:none;
  -moz-appearance:none;
  outline:none;
	width:12px;
	height:12px;
	-webkit-border-radius:2px;
	-moz-border-radius:2px;
	border-radius:2px;
	-moz-box-shadow:inset 0px 0px 1px rgb(200,200,200);
	-webkit-box-shadow:inset 0px 0px 1px rgb(200,200,200);
	box-shadow:inset 0px 0px 1px rgb(200,200,200);
	border:1px solid rgb(200,200,200);
	cursor:pointer;
  margin-right:8px;
}
input[type='radio']:hover:not(:disabled){
  border:1px solid rgb(180,180,180);
}
input[type='radio']:active:not(:disabled){
  border:1px solid rgb(77,144,254);
}
input[type='radio']:checked{
	border:1px solid rgb(77,144,254) !important;
	background:rgb(248,248,255) !important;
}
input[type='radio']:disabled{
  cursor:not-allowed;
}

div.shard canvas{
  height:120px;
  display:block;
}

</style>
<meta charset='UTF-8' NAME='Author' CONTENT='Hunter Larco' />
<title>Shard Testing Console</title>
<link rel="stylesheet" type="text/css" href="/resources/CSS/Forms.css"></link>
<script src='//api.capaching.appspot.com?gateway=/'></script>
</head>
<body>



<script type='text/javascript'>


window.onload = function(){
  
  var counters = 0;
  
  
  function CreateShard(){
    var shard = document.createElement('div');
    shard.setAttribute('class', 'shard');
        var title = document.createElement('div');
        title.setAttribute('class', 'title');
        title.innerHTML = 'Counter N.' + ++counters;
        shard.appendChild(title);
        var inputname = document.createElement('div');
        inputname.setAttribute('class', 'input');
            var iname = document.createElement('input');
            iname.setAttribute('type', 'text');
            iname.setAttribute('placeholder', 'Counter Name');
            inputname.appendChild(iname);
            inputname.appendChild(document.createElement('br'));
            var namespan = document.createElement('span');
            namespan.innerHTML = 'Name';
            inputname.appendChild(namespan);
        shard.appendChild(inputname);
        shard.appendChild(document.createElement('br'));
        var inputvalue = document.createElement('div');
        inputvalue.setAttribute('class', 'input');
            var ivalue = document.createElement('input');
            ivalue.setAttribute('type', 'text');
            ivalue.setAttribute('placeholder', 'Counter Value');
            ivalue.disabled = true;
            inputvalue.appendChild(ivalue);
            inputvalue.appendChild(document.createElement('br'));
            var valuespan = document.createElement('span');
            valuespan.innerHTML = 'Value';
            inputvalue.appendChild(valuespan);
        shard.appendChild(inputvalue);
        shard.appendChild(document.createElement('br'));
        var updatebutton = document.createElement('div');
        updatebutton.setAttribute('class', 'button');
        updatebutton.innerHTML = 'Force Update';
        shard.appendChild(updatebutton);
        var divider = document.createElement('div');
        divider.setAttribute('class', 'divider');
        shard.appendChild(divider);
        var attempts = document.createElement('div');
        attempts.setAttribute('class', 'input');
            var iattempts = document.createElement('input');
            iattempts.setAttribute('type', 'text');
            iattempts.setAttribute('placeholder', 'Increment Attemps');
            attempts.appendChild(iattempts);
            attempts.appendChild(document.createElement('br'));
            var attemptsspan = document.createElement('span');
            attemptsspan.innerHTML = 'Attempts';
            attempts.appendChild(attemptsspan);
        shard.appendChild(attempts);
        shard.appendChild(document.createElement('br'));
        var attemptsfq = document.createElement('div');
        attemptsfq.setAttribute('class', 'input');
            var iattemptsfq = document.createElement('input');
            iattemptsfq.setAttribute('type', 'text');
            iattemptsfq.setAttribute('placeholder', 'Attempts Per Second');
            attemptsfq.appendChild(iattemptsfq);
            attemptsfq.appendChild(document.createElement('br'));
            var attemptsfqspan = document.createElement('span');
            attemptsfqspan.innerHTML = 'Attemps Per Second';
            attemptsfq.appendChild(attemptsfqspan);
        shard.appendChild(attemptsfq);
        shard.appendChild(document.createElement('br'));
        var runbutton = document.createElement('div');
        runbutton.setAttribute('class', 'button');
        runbutton.innerHTML = 'Run &amp; Save';
        shard.appendChild(runbutton);
        var divider = document.createElement('div');
        divider.setAttribute('class', 'divider');
        shard.appendChild(divider);
        var stats = document.createElement('div');
        stats.setAttribute('class', 'stats');
            stats.appendChild(document.createTextNode('Test Completed '));
            var testcompleted = document.createElement('label');
            testcompleted.innerHTML = '?';
            stats.appendChild(testcompleted);
            stats.appendChild(document.createElement('br'));
            stats.appendChild(document.createTextNode('Completed Attempts '));
            var completed = document.createElement('label');
            completed.innerHTML = '0';
            stats.appendChild(completed);
            stats.appendChild(document.createElement('br'));
            stats.appendChild(document.createTextNode('Failed Attempts '));
            var failed = document.createElement('label');
            failed.innerHTML = '0';
            stats.appendChild(failed);
            stats.appendChild(document.createElement('br'));
            stats.appendChild(document.createTextNode('Initial Value '));
            var initialValue = document.createElement('label');
            initialValue.innerHTML = '?';
            stats.appendChild(initialValue);
            stats.appendChild(document.createElement('br'));
            stats.appendChild(document.createTextNode('Final Value '));
            var finalValue = document.createElement('label');
            finalValue.innerHTML = '?';
            stats.appendChild(finalValue);
            stats.appendChild(document.createElement('br'));
            stats.appendChild(document.createTextNode('Difference '));
            var difference = document.createElement('label');
            difference.innerHTML = '?';
            stats.appendChild(difference);
            stats.appendChild(document.createElement('br'));
            stats.appendChild(document.createTextNode('Elapsed Time '));
            var elapsedtime = document.createElement('label');
            elapsedtime.innerHTML = '?';
            stats.appendChild(elapsedtime);
            stats.appendChild(document.createElement('br'));
            stats.appendChild(document.createTextNode('Expected Time '));
            var expectedtime = document.createElement('label');
            expectedtime.innerHTML = '?';
            stats.appendChild(expectedtime);
            stats.appendChild(document.createElement('br'));
            stats.appendChild(document.createTextNode('Shards Available '));
            var shardsavailable = document.createElement('label');
            shardsavailable.innerHTML = '?';
            stats.appendChild(shardsavailable);
            stats.appendChild(document.createElement('br'));
            stats.appendChild(document.createTextNode('Shards Used '));
            var shardsused = document.createElement('label');
            shardsused.innerHTML = '?';
            stats.appendChild(shardsused);
            stats.appendChild(document.createElement('br'));
            stats.appendChild(document.createTextNode('Average Response Time '));
            var averageresponsetime = document.createElement('label');
            averageresponsetime.innerHTML = '?';
            stats.appendChild(averageresponsetime);
        shard.appendChild(stats);
        var divider = document.createElement('div');
        divider.setAttribute('class', 'divider');
        shard.appendChild(divider);
        var graph = document.createElement('div');
        graph.setAttribute('class', 'stats');
            var div = document.createElement('div');
                var canvas = document.createElement('canvas');
                div.appendChild(canvas);
            graph.appendChild(div);
        shard.appendChild(graph);
    
    var shardData = {
      shard: shard,
      title: title,
      runbutton: runbutton,
      updatebutton: updatebutton,
      inputs: {
        name: iname,
        value: ivalue,
        attempts: iattempts,
        attemptsfq: iattemptsfq
      },
      completed: completed,
      failed: failed,
      initialValue: initialValue,
      finalValue: finalValue,
      elapsedtime: elapsedtime,
      expectedtime: expectedtime,
      difference: difference,
      shardsavailable: shardsavailable,
      shardsused: shardsused,
      canvas: canvas,
      averageresponsetime: averageresponsetime,
      testcompleted: testcompleted
    }
    
    iattempts.addEventListener('keypress', AllowOnlyNumbers);
    iattemptsfq.addEventListener('keypress', AllowOnlyNumbers);
    
    runbutton.addEventListener('click', function(){
      RunShard(shardData);
    });
    
    updatebutton.addEventListener('click', function(){
      if(shardData.inputs.name.value.length == 0){
        shardData.inputs.value.value = 'Invalid Counter Name';
        return;
      }
      function OnError(message){
        shardData.inputs.value.value = message;
      }
      function Callback(event){
        if(event.stat == 'fail')
          return OnError(event.message);
        shardData.inputs.value.value = event.value;
      }
      shardData.inputs.value.value = 'Working...';
      GetShardValue(shardData, Callback, OnError);
    });
    
    document.body.insertBefore(shard, document.body.firstChild);
  }
  
  
  
  function AllowOnlyNumbers(event){
    var charCode = (event.which) ? event.which : event.keyCode;
    if(charCode > 31 && (charCode < 48 || charCode > 57))
      event.preventDefault();
  }
  
  
  
  function FormatTime(s) {
    function chop(num){
      return Math.round(num*10)/10;
    }
    var ms = s % 1000;
    s = (s - ms) / 1000;
    var secs = s % 60;
    s = (s - secs) / 60;
    var mins = s % 60;
    var hrs = (s - mins) / 60;
    return chop(hrs) + 'h : ' + chop(mins) + 'm : ' + chop(secs) + 's : ' + chop(ms) + 'ms';
  }     
  
  
  
  function GetShardValue(data, Callback, OnError){
    var request = new Request('shards/get');
    request.post({
      'name': data.inputs.name.value
    }, Callback, OnError);
  }
  
  
  
  function findLineByLeastSquares(values_x, values_y) {
      var sum_x = 0;
      var sum_y = 0;
      var sum_xy = 0;
      var sum_xx = 0;
      var count = 0;

      /*
       * We'll use those variables for faster read/write access.
       */
      var x = 0;
      var y = 0;
      var values_length = values_x.length;

      if (values_length != values_y.length) {
          throw new Error('The parameters values_x and values_y need to have same size!');
      }

      /*
       * Nothing to do.
       */
      if (values_length === 0) {
          return [ [], [] ];
      }

      /*
       * Calculate the sum for each of the parts necessary.
       */
      for (var v = 0; v < values_length; v++) {
          x = values_x[v];
          y = values_y[v];
          sum_x += x;
          sum_y += y;
          sum_xx += x*x;
          sum_xy += x*y;
          count++;
      }

      /*
       * Calculate m and b for the formular:
       * y = x * m + b
       */
      var m = (count*sum_xy - sum_x*sum_y) / (count*sum_xx - sum_x*sum_x);
      var b = (sum_y/count) - (m*sum_x)/count;

      return {
        m: m,
        b: b
      }
  }
  
  
  
  function UpdateGraph(data){
    var canvas = data.canvas,
        ctx = canvas.ctx,
        total = canvas.total,
        used = canvas.used,
        last_update = canvas.last_update,
        width = canvas.width,
        height = canvas.height,
        now = Date.now(),
        x = used/total*width,
        y = (now-last_update)/(1/2)/1000*height;
    ctx.beginPath();
    ctx.arc(
      x,
      height - y,
      1,
      0, Math.PI*2, true
    );
    ctx.fill();
    canvas.last_update = now;
    canvas.used++;
    canvas.values_x.push(x);
    canvas.values_y.push(y);
  }
  
  
  
  function FinalizeGraph(data){
    var canvas = data.canvas,
        ctx = canvas.ctx,
        total = canvas.total,
        height = canvas.height,
        width = canvas.width,
        partitions = 3,
        partition_size = Math.ceil(canvas.values_x.length/partitions);
    ctx.strokeStyle = 'rgb(200,0,0)';
    ctx.lineWidth = 2;
    ctx.beginPath();
    for(var p=0; p<partitions; p++){
      var xvals = canvas.values_x.slice(p*partition_size, p*partition_size+partition_size),
          yvals = canvas.values_y.slice(p*partition_size, p*partition_size+partition_size),
          line = findLineByLeastSquares(xvals, yvals),
          m = line.m,
          b = line.b,
          partition_width = Math.ceil(width/partitions);
      for(var x=0; x<partition_width; x++){
        var funct = x==0 ? ctx.moveTo : ctx.lineTo;
        funct.call(ctx, x+p*partition_width, height - (m*x+b));
      }
    }
    ctx.stroke();
    ctx.lineWidth = 1;
    ctx.strokeStyle = 'rgb(0,0,0)';
  }
  
  
  
  function DoPost(data, postcallback){
    if(parseInt(data.failed.innerHTML) >= 500){
      data.completed.innerHTML = parseInt(data.completed.innerHTML)+1;
      var total = parseInt(data.completed.innerHTML),
          expected = parseInt(data.inputs.attempts.value);
      if(total == expected){
        postcallback();
        datatestcompleted.innerHTML = 'False';
        alert('Test Aborted Due to too Many Errors');
      }
      return;
    };
    var request = new Request('shards/increment');
    function OnError(){
      data.failed.innerHTML = parseInt(data.failed.innerHTML)+1;
      DoPost(data);
    }
    function Callback(){
      UpdateGraph(data);
      data.completed.innerHTML = parseInt(data.completed.innerHTML)+1;
      var total = parseInt(data.completed.innerHTML),
          expected = parseInt(data.inputs.attempts.value);
      if(total == expected){
        data.testcompleted.innerHTML = 'True';
        postcallback();
      }
    }
    request.post({
      'name': data.inputs.name.value
    }, Callback, OnError);
  }
  
  
  function RunShard(data){
    if(data.inputs.name.value.length == 0){
      data.inputs.value.value = 'Invalid Counter Name';
      return;
    }
    
    // disabled all buttons and inputs beside the update button
    for(var key in data.inputs)
      data.inputs[key].disabled = true;
    for(var key in data.radios){
      data.radios[key].disabled = true;
      data.radios[key].removeAttribute('name');
    }
    data.shard.removeChild(data.runbutton);
    
    // important globals
    var starttime,
        initialtitle = data.title.innerHTML;
    
    // begin the runner and set title to working
    data.title.innerHTML += ' (working)';
    init();
    
    // find the current shard value and then begin, on error try again
    function init(){
      GetShardValue(data, DoAllPosts, init);
    }
    
    // once all increments are completed, this is run
    function OnFinish(){
      var elapsedtime = Date.now()-starttime;
      function OnComplete(event){
        if(event.stat == 'fail')
          return getFinalValue();
        
        var finalValue = event.value;
        data.finalValue.innerHTML = finalValue;
        data.difference.innerHTML = finalValue - parseInt(data.initialValue.innerHTML);
        data.elapsedtime.innerHTML = FormatTime(elapsedtime);
        
        CheckShards();
        
        function CheckShards(){
          var request = new Request('shards/profile');
          request.post({
            'name': data.inputs.name.value
          }, ShardCheckFinished, CheckShards);
        }
        
        function ShardCheckFinished(event){
          data.shardsused.innerHTML = event.shards_used;
          data.shardsavailable.innerHTML = event.shards_available;
          data.title.innerHTML = initialtitle + ' (finished)';
          
          FinalizeGraph(data);
          
          var averageResponseTime = 0;
          for(var i=0; i<data.canvas.values_y.length; i++)
            averageResponseTime += data.canvas.values_y[i];
          averageResponseTime /= data.canvas.values_y.length;
          
          data.averageresponsetime.innerHTML = Math.round(1000*averageResponseTime)/1000+'ms';
          
          CreateShard();
        }
      }
      function getFinalValue(){
        GetShardValue(data, OnComplete, getFinalValue);
      }
      getFinalValue();
    }
    
    // runs all of the posts
    function DoAllPosts(event){
      if(event.stat == 'fail')
        return init();
      
      var times = parseInt(data.inputs.attempts.value),
          fq = parseInt(data.inputs.attemptsfq.value);
  
      data.expectedtime.innerHTML = FormatTime(1000/fq*times);
    
      data.canvas.ctx = data.canvas.getContext('2d');
      data.canvas.total = times;
      data.canvas.used = 0;
      data.canvas.values_x = [];
      data.canvas.values_y = [];
      data.canvas.width = data.canvas.parentElement.offsetWidth;
      data.canvas.height = data.canvas.parentElement.offsetHeight;
      data.canvas.last_update = starttime = Date.now();
      
      data.initialValue.innerHTML = event.value;
    
      for(var i=0; i<times; i++){
        setTimeout(function(){
          DoPost(data, OnFinish);
        }, 1000/fq*i);
      }
    }
    
    
  }
  
  
  
  
  
  CreateShard();
}


</script>
</body>
</html>
